default_platform(:ios)

KEYCHAIN_NAME = "cloude-build.keychain"
KEYCHAIN_PASSWORD = "cloude-build-temp"

def setup_signing
  cert_path = File.expand_path("../certs/distribution.p12", __dir__)
  cert_password = ENV["CERT_PASSWORD"]

  unless File.exist?(cert_path)
    UI.user_error!("Certificate not found at #{cert_path}")
  end

  unless cert_password
    UI.user_error!("CERT_PASSWORD not set in environment")
  end

  sh("security delete-keychain #{KEYCHAIN_NAME} 2>/dev/null || true")
  sh("rm -f ~/Library/Keychains/#{KEYCHAIN_NAME}-db 2>/dev/null || true")

  create_keychain(
    name: KEYCHAIN_NAME,
    password: KEYCHAIN_PASSWORD,
    default_keychain: true,
    unlock: true,
    timeout: 21600
  )

  import_certificate(
    certificate_path: cert_path,
    certificate_password: cert_password,
    keychain_name: KEYCHAIN_NAME,
    keychain_password: KEYCHAIN_PASSWORD
  )

  sh("security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k '#{KEYCHAIN_PASSWORD}' #{KEYCHAIN_NAME}")
  sh("security list-keychains -d user -s #{KEYCHAIN_NAME} login.keychain-db")

  UI.success("Signing keychain configured")
end

def cleanup_signing
  sh("security default-keychain -s login.keychain-db")
  sh("security list-keychains -d user -s login.keychain-db")
  sh("security delete-keychain #{KEYCHAIN_NAME} 2>/dev/null || true")
  UI.success("Signing keychain cleaned up")
end

platform :ios do
  desc "Build and upload iOS app to TestFlight"
  lane :beta_local do
    begin
      setup_signing

      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        is_key_content_base64: false
      )

      increment_build_number(
        xcodeproj: "Cloude/Cloude.xcodeproj",
        build_number: latest_testflight_build_number(
          api_key: api_key,
          app_identifier: "soli.Cloude"
        ) + 1
      )

      update_code_signing_settings(
        use_automatic_signing: true,
        path: "Cloude/Cloude.xcodeproj",
        team_id: "Q9U8224WWM",
        targets: ["Cloude"]
      )

      build_app(
        project: "Cloude/Cloude.xcodeproj",
        scheme: "Cloude",
        export_method: "app-store",
        export_xcargs: "-allowProvisioningUpdates",
        export_options: {
          signingStyle: "automatic",
          teamID: "Q9U8224WWM"
        }
      )

      upload_to_testflight(
        api_key: api_key,
        skip_waiting_for_build_processing: true,
        distribute_external: false
      )
    ensure
      cleanup_signing
    end
  end
end

platform :mac do
  desc "Build and run Mac agent locally"
  lane :build_agent do
    begin
      setup_signing

      log_dir = File.expand_path("~/Library/Logs/Cloude")
      FileUtils.mkdir_p(log_dir)
      deploy_log = File.join(log_dir, "deploy.log")

      File.open(deploy_log, "a") do |f|
        f.puts "\n#{'=' * 60}"
        f.puts "DEPLOY STARTED: #{Time.now}"
        f.puts "#{'=' * 60}"
      end

      sh("xcodebuild -project ../Cloude/Cloude.xcodeproj -scheme 'Cloude Agent' -destination 'platform=macOS' -derivedDataPath ../build build 2>&1 | tee -a #{deploy_log}")

      File.open(deploy_log, "a") do |f|
        f.puts "BUILD COMPLETE: #{Time.now}"
        f.puts "Killing old agent..."
      end

      sh("pkill -TERM -x 'Cloude Agent' || true")
      sh("sleep 2")
      sh("pkill -9 -x 'Cloude Agent' || true")
      sh("sleep 2")

      File.open(deploy_log, "a") do |f|
        f.puts "Launching new agent: #{Time.now}"
      end

      sh("open -n ../build/Build/Products/Debug/Cloude\\ Agent.app")

      File.open(deploy_log, "a") do |f|
        f.puts "LAUNCH COMMAND SENT: #{Time.now}"
        f.puts "Check ~/Library/Logs/Cloude/agent.log for startup logs"
        f.puts "#{'=' * 60}\n"
      end
    ensure
      cleanup_signing
    end
  end

  desc "Build, notarize, and create DMG for Mac agent distribution"
  lane :release_agent do
    begin
      setup_signing

      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        is_key_content_base64: false
      )

      build_mac_app(
        project: "Cloude/Cloude.xcodeproj",
        scheme: "Cloude Agent",
        output_directory: "build/release",
        output_name: "Cloude Agent",
        export_method: "developer-id",
        export_options: {
          signingStyle: "automatic",
          teamID: "Q9U8224WWM"
        }
      )

      notarize(
        api_key: api_key,
        package: "build/release/Cloude Agent.app",
        bundle_id: "soli.Cloude-Agent",
        print_log: true
      )

      sh("hdiutil create -volname 'Cloude Agent' -srcfolder '../build/release/Cloude Agent.app' -ov -format UDZO '../build/release/Cloude-Agent.dmg'")

      UI.success("DMG created at build/release/Cloude-Agent.dmg")
    ensure
      cleanup_signing
    end
  end
end

desc "Deploy both: iOS to TestFlight + Mac agent locally"
lane :deploy do
  Fastlane::LaneManager.cruise_lane("mac", "build_agent")
  Fastlane::LaneManager.cruise_lane("ios", "beta_local")
end
